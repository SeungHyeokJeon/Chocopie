{% load static %}
<!DOCTYPE HTML>
<!--
	Future Imperfect by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>가게 상세정보 보기!!!</title>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link rel="stylesheet" href="../../static/css/store_inform.css" />

		<meta http-equiv="X-UA-Compatible" content="IE=Edge">
		<meta name="description" content="">
		<meta name="keywords" content="">
		<meta name="author" content="">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
		<link rel="stylesheet" href="../../static/css/bootstrap.min.css">
		<link rel="stylesheet" href="../../static/css/font-awesome.min.css">
		<link rel="stylesheet" href="{% static 'css/style.css' %}">
		
		<link href="https://fonts.googleapis.com/css?family=Work+Sans:300,400,700" rel="stylesheet">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

	</head>

	<body>

<!-- Navigation section  -->
<div class="navbar navbar-default navbar-static-top" role="navigation">
	<div class="container">
		 <div class="navbar-header">
			  <button class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
				   <span class="icon icon-bar"></span>
				   <span class="icon icon-bar"></span>
				   <span class="icon icon-bar"></span>
			  </button>
			  <a href="{% url 'mainpage:mainpage' %}" class="navbar-brand"><img class="logo" src="{% static 'images/logo.png' %}"></a>
		 </div>
		 <div class="collapse navbar-collapse">
			  <ul class="nav navbar-nav navbar-right">
				   <!-- <li class="active"><a href="index.html">Projects</a></li> -->
				   {% if user.is_authenticated %}
				   {{user.username}} 님이 로그인중
				   <li><a href="#" class="fa fa-shopping-cart"></a></li>
				   <li><a href="{% url 'mainpage:mypage' %}" class="fa fa-user"></a></li>
				   <li><a href="{% url 'accounts:logout' %}">Logout</a> </li>
				   {% else %}
				   <li><a href="{% url 'accounts:login' %}">Login</a> </li>
				   {% endif %}
			  </ul>
		 </div>

 </div>
</div>

		
<!-- 가게 상세정보 보기 -->
		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Main -->
				<div id="postlist">
					{% if board %}
						<input id="page" type="hidden" value="2">
						{% for postlist in board %}
					<!-- Post -->
						<div class="post infinite-container" id="post{{postlist.id}}">

							<!-- 게시글 제목 -->
							<header>
								<div class="title">
									<h2><a href="#">{{postlist.title}}</a></h2>
								</div>
								<div class="meta">
									<time class="published" datetime="{{postlist.date_posted}}">{{postlist.date_posted}}</time>
									<a href="#" class="author"><span class="name">{{postlist.writer_name}}</span></a>
								</div>
							</header>

							<a href="#" class="image featured"><img src="{{postlist.thumbnail}}" alt="" /></a>
							{{postlist.content | safe}}
							
							<div id="items">
								<!-- 물품 들어갈 자리 -->
								{% if postlist.item %}
									<form method="post" action="#">
										<hr>
										<div class="row uniform" style="margin-top: 10px; display: flex; justify-content: center; align-items: center; flex-direction: column;">
											<div class="8u$" id="itemselect">
												<div class="select-wrapper">
													<select name="demo-category" id="postItem{{postlist.id}}" onchange="selectItem({{postlist.id}})">
														<option value="none"> 품목 </option>
														{% for idx in item %}
															{% if idx.board_id.id == postlist.id %}
																<option value="{{idx.id}}">{{idx.name}}</option>
															{% endif %}
														{% endfor %}
													</select>
												</div>
											</div>
											<div class="8u$" id="selectedItems{{postlist.id}}">
												<!-- 선택된 물품이 들어갈 자리 -->
											</div>

											<div class="8u$">
												<label style="color:black; font-size:16px; height: 45px; line-height: 45px;">총 상품 금액</label>
												<label for="itemprice" style="padding:0; margin-top:5px; margin-right:45px; height: 45px; font-size:26px; color:red; float: right;">원</label>
												<input style="text-align:right; color:red; margin:0; margin-right:10px; padding:0px; height: 45px; width:100px; font-size: 26px; float: right; font-weight: bold; display:inline; border:none; " type="text" name="totalPrice{{postlist.id}}" value=0 disabled>
											</div>
											<div class="8u$">
												<ul class="actions fit">
													<li><input type="submit" value="장바구니 담기" /></li>
													<li><input style="margin-left:133px;" type="reset" value="취소" /></li>
												</ul>
											</div>
										</div>
									</form>
								{% endif %}
							</div>

							<footer>
								<ul class="actions">
									<!-- <li><a href="single.html" class="button big">글 상세보기</a></li> -->
								</ul>
								<ul class="stats">
									<li></li>
									<!-- <li><a href="#" class="icon fa-heart">28</a></li> -->
									<!-- <li><a href="#" class="icon fa-comment">{{postlist.views}}</a></li> -->
								</ul>
							</footer>

						</div>
						{% endfor %}

					{% else %}
						<div class="post">
							<a class="image featured">게시글이 존재하지 않습니다.</a>
						</div>

					{% endif %}

				</div>


				<div id="about">
				<!-- Sidebar -->
					<section id="sidebar">
						<!-- Intro -->
							<section id="intro">
								<header>
									<h2>{{store.name}}</h2>
								</header>
							</section>

							<section>
								<p> {{store.introduce}}</p>
							</section>

							<section>
								<p>Tel. {{store.phone}}</p>
								<p>{{store.address}}</p>
							</section>

							{% if store.owner_id == user.id %}
							<section>
								<a href="{% url 'mainpage:post_write' store_id=store.id %}" class="button big">글쓰기</a>
							</section>
							{% endif %}

					

					
					</section>

				</div>
		</div>
			
	<!-- Footer Section -->

	<footer>
		<div class="container">
			<div class="row">

				<div class="col-md-3 col-sm-3">
					<img class="logo" src="../../static/images/logo.png">
				</div>

				<div class="col-md-4 col-sm-4">
					<p>124 Market Street, Suite 3570 San Francisco, CA 3042 United States</p>
				</div>

				<div class="col-md-offset-1 col-md-4 col-sm-offset-1 col-sm-3">
					<p><a href="mailto:youremail@gmail.com">hello@yourstudio.co</a></p>
					<p>(+01) 2048937 / 02 203403</p>
				</div>

				<div class="clearfix col-md-12 col-sm-12">
					<hr>
				</div>

				<div class="col-md-6 col-sm-6">
					<div class="footer-copyright">
							<p>© 2016 Magnet Studio | All Rights Reserved.</p>
					</div>
				</div>

				<div class="col-md-6 col-sm-6">
					<ul class="social-icon">
							<li><a href="#" class="fa fa-facebook"></a></li>
							<li><a href="#" class="fa fa-twitter"></a></li>
							<li><a href="#" class="fa fa-linkedin"></a></li>
					</ul>
				</div>
				
			</div>
		</div>
	</footer>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
	<script>
		var token = $('input[name="csrfmiddlewaretoken"]').prop('value');

		//만약 현재 페이지를 파라미터로 가져와서 값이 있으면
		var paramPage = getParameterByName('page');
		//파라미터로 가져온 페이지+1하고 없으면 2로 지정
		var page = paramPage===''?$("#page").val():parseInt(paramPage)+1;
		$("#page").val(parseInt(page)); // 가져온 페이지로 input 값 대체

		$(window).scroll(function(){
			// 현재 하단 스크롤 위치
			var scrollHeight = $(window).scrollTop() + $(window).outerHeight();
			// 페이지 전체 높이
			var documentHeight = $(document).height();
			console.log(scrollHeight, documentHeight);

			if(scrollHeight>=documentHeight-0.5 && page!=="{{totalPage}}" && "{{totalPage}}"!=="1") {
				page = $("#page").val();
				callMorePostAjax(page);
				$("#page").val(parseInt(page)+1);
			}
		});
		
		// 다른 페이지에서 다음 페이지 정보를 로드해서 갖고옴
		function callMorePostAjax(page) {
			$.ajax({
				type:'POST',
				url: "{% url 'mainpage:detailStore_ajax' id=store.id %}",
				contentType: 'application/x-www-form-urlencoded; charset=utf-8',
				data: {
					'page': page,
					'csrfmiddlewaretoken': token
				},
				success: addMorePostAjax,
				dataType: 'html'
			});
		}

		// 다음 페이지 게시글을 아래에 추가
		function addMorePostAjax(data, textStatus, jqXHR) {
			$('#postlist').append(data);
		}
		// page 파라미터 가져오기
		function getParameterByName(name) {
			name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
			var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
					results = regex.exec(location.search);
			return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
		}

		// 상품 선택
		function selectItem(postid) {
			var selectedItem = $('#postItem'+postid).val();
			if(selectedItem!='none' && $('#selectedItem'+selectedItem).length===0) {
				// 상품 정보 가져오기
				for(var i=0;i<1;i++) {
					{% for idx in item %}
						if(selectedItem=={{idx.id}}) {
							var id = parseInt("{{idx.id}}")
							var name = "{{idx.name}}";
							var price = parseInt("{{idx.price}}");
							break;
						}
					{% endfor %}
				}
				
				// 상품 선택 태그 추가
				var tag = 	'<div id="selectedItem'+id+'">';
					tag +=		'<input type="hidden" name="itemoriginalprice" value='+price+'>'
					tag +=		'<input type="text" name="itemname" value="'+name+'" disabled>'
					tag +=		'<div style="height:45px;">'
					tag +=			'<button style="padding:0px; box-shadow: none;" type="button" onclick="fnCalCount('+postid+','+id+',\'minus\');">-</button>'
					tag +=			'<input style="text-align: center;" type="number" name="itemcount" value=1 onchange="changeItemCount('+postid+','+id+')" min="1" max="10000" required>'
					tag +=			'<button style="padding: 0px; box-shadow: none; width:10px;" type ="button" onclick="fnCalCount('+postid+','+id+',\'plus\');">+</button>'
					tag +=			'<button style="padding: 0px; height: 45px; margin-left: 10px; margin-right: 10px; float: right; font-size: 26px; padding: 0px; box-shadow: none;" onclick="deleteItem('+postid+','+id+')"><i style="color:black;" class="fa fa-times"></i></button>'
					tag += 			'<label for="itemprice" style="padding:0; margin-top:5px; font-weight:normal; height: 45px; font-size:26px; color:black; float: right;">원</label>'
					tag +=			'<input style="text-align:right; margin:0; margin-right:10px; font-weight:normal; padding:0px; height: 45px; width:100px; font-size: 26px; float: right; display:inline; border:none; " type="text" name="itemprice" value='+price+' disabled>'
					tag +=		'</div>'
					tag += '<hr>'			
					tag +=	'</div>';
					
				$('#selectedItems'+postid).append(tag);

				// 해당 상품 합계 설정
				setTotalPrice(postid);
			}
		}
		function fnCalCount(postid, num, type){
			var itemcount = parseInt($('#selectedItem'+num).find($('input[name=itemcount]')).val());
			if(type==='plus'){
				$('#selectedItem'+num).find($('input[name=itemcount]')).val(itemcount+1);
			}
			else {
				if(itemcount-1==0) {
					$('#selectedItem'+num).find($('input[name=itemcount]')).val(1);
				}
				else {
					$('#selectedItem'+num).find($('input[name=itemcount]')).val(itemcount-1);
				}
			}
			changeItemCount(postid,num);
		}

		function changeItemCount(postid, num) {
			var itemoriginalprice1 = $('#selectedItem'+num).find($('input[name=itemoriginalprice]')).val();
			var itemcount = parseInt($('#selectedItem'+num).find($('input[name=itemcount]')).val());

			// 해당 상품 합계 설정
			var itemprice = document.getElementsByName("itemprice");
			$('#selectedItem'+num).find($('input[name=itemprice]')).val(itemoriginalprice1*itemcount);

			setTotalPrice(postid);
		}

		function deleteItem(postid, num, textStatus, jqXHR) {
			$('#selectedItem'+num).remove();

			setTotalPrice(postid);
		}

		function setTotalPrice(postid) {
			// 선택된 상품 요소의 개수를 통해 각각 아이템 값을 더해줌
			var totalprice = 0;
			$('#selectedItems'+postid).find($('input[name=itemprice]')).each(function(idx) {
				totalprice += parseInt($(this).val());
			});

			$('input[name=totalPrice'+String(postid)+']').val(totalprice);
		}
	</script>

	</body>
</html>